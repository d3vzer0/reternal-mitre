name: '[T1075] Pass the Hash NULL SID'
integration: Splunk
reference: https://github.com/olafhartong/ThreatHunting
description: Hunting query based on sysmon or windows events for Splunk
author: olafhartong
mitre_technique:
  id: T1075
  datasources:
  - Authentication logs
coverage:
  app:
    and: ThreatHunting
  sourcetype:
    and:
    - wineventlog:security
search: '`windows-security` event_id=4624 AND ((Security_ID="NULL SID" OR Security_ID="S-1-0-0")
  AND (Logon_Type="3") AND (Source_Network_Address != "*::1*") AND (Logon_Process="*NtLmSsp")
  AND (Package_Name__NTLM_only_="*NTLM V2") AND (Key_Length="0") AND (user != "*ANONYMOUS
  LOGON" OR Account_Name != "*ANONYMOUS LOGON")) \

  | eval target_user_name=mvindex(Account_Name,1) \

  | eval user_name=mvindex(Account_Name,0) \

  | eval target_user_domain=mvindex(Account_Domain,1) \

  | rename ComputerName as host_fqdn, Source_Network_Address as src_ip, Workstation_Name
  as src_host_name \

  | eval indextime = _indextime \

  | convert ctime(indextime) \

  | table _time indextime,host_fqdn, user_sid, user_name src_host_name src_ip target_user_name
  target_user_domain'
