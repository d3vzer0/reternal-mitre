name: '[T1086] PowerShell Base64 block used'
integration: Splunk
reference: https://github.com/olafhartong/ThreatHunting
description: Hunting query based on sysmon or windows events for Splunk
author: olafhartong
mitre_technique:
  id: T1086
  datasources:
  - Process command-line parameters
  - Process monitoring
coverage:
  app:
    and: ThreatHunting
  sourcetype:
    or:
    - wineventlog:security
    - XmlWinEventLog:Microsoft-Windows-Sysmon/Operational
search: "| multisearch \\\n    [ search `indextime` `powershell` (event_id=400 OR\
  \ event_id=500) \\\n    | eval MessageA=split(Message,\"Details:\") \\\n    | eval\
  \ Short_Message=mvindex(MessageA,1) \\\n    | eval MessageA=split(Short_Message,\"\
  HostVersion=\") \\\n    | eval MessageA=mvindex(MessageA,1) \\\n    | eval MessageB=split(MessageA,\"\
  HostId=\") \\\n    | eval PS_Version=mvindex(MessageB,0) \\\n    | eval MessageC=mvindex(MessageB,1)\
  \ \\\n    | eval MessageD=split(MessageC,\"HostApplication=\") \\\n    | eval Host_ID=mvindex(MessageD,0)\
  \ \\\n    | eval MessageE=mvindex(MessageD,1) \\\n    | eval MessageF=split(MessageE,\"\
  EngineVersion=\") \\\n    | eval Host_Application=mvindex(MessageF,0) \\\n    |\
  \ eval MessageG=mvindex(MessageF,1) \\\n    | eval MessageH=split(MessageG,\"RunspaceId=\"\
  ) \\\n    | eval Engine_Version=mvindex(MessageH,0) \\\n    | eval MessageJ=mvindex(MessageH,1)\
  \ \\\n    | eval MessageP=split(MessageJ,\"process_command_line=\") \\\n    | eval\
  \ Command_Line=mvindex(MessageP,1) \\\n    | rex field=Host_Application \"(?<Base64_Data>.[a-zA-Z0-9]{25,1000}+={1})\"\
  \ \\\n    | fields _time host_fqdn, host, PS_Version, Engine_Version, Host_Application,\
  \ base64_data, Command_Line | rename Command_Line as process_command_line, HostName\
  \ as host_fqdn, Host_Application as process_path\\\n    | where NOT isnull(base64_data)]\
  \  \\\n    [ search `indextime` `windows-security` (event_id=4688) \\\n    | rex\
  \ field=Process_Command_Line \"(?<base64_data>.[a-zA-Z0-9]{25,1000}+={1})\" \\\n\
  \    | fields _time host base64_data, Process_Command_Line | rename Process_Command_Line\
  \ as process_command_line, HostName as host_fqdn\\\n    | where NOT isnull(base64_data)]\
  \ \\\n    [ search `indextime` `sysmon` (event_id=1) process_name=\"powershell.exe\"\
  \ \\\n    | rex field=process_command_line \"(?<base64_data>.[a-zA-Z0-9//+]{25,1000}+={1})\"\
  \ \\\n    | fields _time host_fqdn base64_data, process_command_line, process_path,\
  \ user_name \\\n    | where NOT isnull(base64_data)] \\\n| eval indextime = _indextime\
  \ | convert ctime(indextime) | table _time indextime, host, base64_data, PS_Version,\
  \ Engine_Version, Host_Application, process_command_line, process_path, user_name"
